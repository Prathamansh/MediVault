<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#DC2626" />
    <meta
      name="description"
      content="MediVault - Emergency Access Page"
    />
    <title>Emergency Access - MediVault</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Custom Tailwind Config -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: {
                light: '#4DA8DA',
                DEFAULT: '#0078D7',
                dark: '#005A9E',
              },
              secondary: {
                light: '#F8FAFC',
                DEFAULT: '#E5E7EB',
                dark: '#6B7280',
              },
              emergency: {
                DEFAULT: '#DC2626',
              }
            },
            boxShadow: {
              'card': '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)',
            }
          },
        }
      };
    </script>
    <!-- Custom CSS -->
    <style>
      body {
        font-family: 'Inter', 'Segoe UI', 'Roboto', sans-serif;
        background-color: #DC2626;
      }
      .page-container {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }
      .card {
        background-color: white;
        border-radius: 0.75rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
      }
      .btn {
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-weight: 500;
        transition: background-color 0.2s;
      }
      .emergency-panel {
        position: fixed;
        inset: 0;
        background-color: white;
        z-index: 50;
        overflow: auto;
        padding: 1.5rem;
      }
      .text-emergency {
        color: #DC2626;
      }
      .text-gray-700 {
        color: #374151;
      }
      .text-gray-600 {
        color: #4B5563;
      }
      .text-gray-800 {
        color: #1F2937;
      }
      .hidden {
        display: none;
      }
      .flex {
        display: flex;
      }
      .flex-col {
        flex-direction: column;
      }
      .items-center {
        align-items: center;
      }
      .justify-center {
        justify-content: center;
      }
      .justify-between {
        justify-content: space-between;
      }
      .text-center {
        text-align: center;
      }
      .text-lg {
        font-size: 1.125rem;
      }
      .text-xl {
        font-size: 1.25rem;
      }
      .text-2xl {
        font-size: 1.5rem;
      }
      .text-3xl {
        font-size: 1.875rem;
      }
      .font-bold {
        font-weight: 700;
      }
      .font-medium {
        font-weight: 500;
      }
      .mb-4 {
        margin-bottom: 1rem;
      }
      .mb-6 {
        margin-bottom: 1.5rem;
      }
      .mb-8 {
        margin-bottom: 2rem;
      }
      .mt-2 {
        margin-top: 0.5rem;
      }
      .mt-6 {
        margin-top: 1.5rem;
      }
      .min-h-screen {
        min-height: 100vh;
      }
      .rounded-lg {
        border-radius: 0.5rem;
      }
      .py-4 {
        padding-top: 1rem;
        padding-bottom: 1rem;
      }
      .px-6 {
        padding-left: 1.5rem;
        padding-right: 1.5rem;
      }
      .py-12 {
        padding-top: 3rem;
        padding-bottom: 3rem;
      }
      .w-full {
        width: 100%;
      }
      .w-20 {
        width: 5rem;
      }
      .h-20 {
        height: 5rem;
      }
      .mx-auto {
        margin-left: auto;
        margin-right: auto;
      }
      .rounded-full {
        border-radius: 9999px;
      }
      .max-w-md {
        max-width: 28rem;
      }
      .space-x-4 > * + * {
        margin-left: 1rem;
      }
      .space-y-4 > * + * {
        margin-top: 1rem;
      }
      .grid {
        display: grid;
      }
      .grid-cols-1 {
        grid-template-columns: repeat(1, minmax(0, 1fr));
      }
      .gap-6 {
        gap: 1.5rem;
      }
      .list-disc {
        list-style-type: disc;
      }
      .pl-5 {
        padding-left: 1.25rem;
      }
      .border-b {
        border-bottom-width: 1px;
      }
      .border-gray-300 {
        border-color: #D1D5DB;
      }
      .pb-4 {
        padding-bottom: 1rem;
      }
      .hover\:bg-gray-100:hover {
        background-color: #F3F4F6;
      }
      .hover\:underline:hover {
        text-decoration: underline;
      }
      .animate-spin {
        animation: spin 1s linear infinite;
      }
      .last-updated {
        font-size: 0.75rem;
        color: #6B7280;
        text-align: right;
        margin-top: 1rem;
      }
      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }
      @media (min-width: 768px) {
        .md\:grid-cols-2 {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
        .md\:flex-row {
          flex-direction: row;
        }
      }
    </style>
  </head>
  <body>
    <div id="emergency-landing" class="page-container">
      <div class="flex flex-col items-center justify-center min-h-screen px-6 py-12">
        <div class="w-full max-w-md text-center">
          <div class="w-20 h-20 mx-auto mb-8 bg-white rounded-full flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-emergency" viewBox="0 0 20 20" fill="currentColor">
              <path d="M2.93 17.07A10 10 0 1 1 17.07 2.93 10 10 0 0 1 2.93 17.07zm12.73-1.41A8 8 0 1 0 4.34 4.34a8 8 0 0 0 11.32 11.32zM9 5h2v6H9V5zm0 8h2v2H9v-2z"/>
            </svg>
          </div>
          
          <h1 class="text-3xl font-bold mb-4 text-white">Emergency Access</h1>
          <p class="text-xl mb-8 text-white">
            Access critical medical information for emergency situations
          </p>
          
          <button
            id="view-emergency-info"
            class="w-full bg-white text-emergency font-bold py-4 px-6 rounded-lg text-lg mb-6 hover:bg-gray-100 transition-colors"
          >
            View Emergency Information
          </button>
          
          <p class="text-sm mb-6 text-white">
            This page provides access to critical medical information for emergency responders.
            No login required.
          </p>
          
          <div class="flex justify-center space-x-4">
            <a href="index.html" class="text-white hover:underline">
              Return to Home
            </a>
            <a href="login.html" class="text-white hover:underline">
              Login
            </a>
          </div>
        </div>
      </div>
    </div>
        
    <!-- Emergency Panel (Hidden by default) -->
    <div id="emergency-panel" class="emergency-panel hidden">
      <div class="flex justify-between items-center border-b border-gray-300 pb-4 mb-6">
        <h1 class="text-2xl font-bold text-emergency">Emergency Information</h1>
        <button id="close-emergency-panel" class="text-gray-500 hover:text-gray-700">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      
      <div id="loading" class="text-center py-8">
        <svg class="animate-spin h-10 w-10 mx-auto mb-4 text-emergency" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="text-gray-600">Loading medical information...</p>
      </div>
      
      <div id="emergency-content" class="hidden">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="card">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">Critical Medical Information</h2>
            
            <div class="space-y-4">
              <div>
                <h3 class="font-medium text-gray-700">Blood Group</h3>
                <p id="emergency-blood-group" class="text-2xl font-bold text-emergency">-</p>
              </div>
              
              <div>
                <h3 class="font-medium text-gray-700">Critical Conditions</h3>
                <ul id="critical-conditions-list" class="list-disc pl-5 mt-2">
                  <li class="text-gray-800">Loading...</li>
                </ul>
              </div>
              
              <div>
                <h3 class="font-medium text-gray-700">Allergies</h3>
                <ul id="allergies-list" class="list-disc pl-5 mt-2">
                  <li class="text-gray-800">Loading...</li>
                </ul>
              </div>
              
              <p id="last-updated" class="last-updated">Last updated: <span id="update-date">-</span></p>
            </div>
          </div>
          
          <div class="card">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">Emergency Contact</h2>
            
            <div id="emergency-contacts">
              <p class="text-gray-600 mb-4">Loading emergency contacts...</p>
            </div>
            
            <button id="emergency-call-btn" class="w-full bg-emergency text-white font-bold py-4 px-6 rounded-lg flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z" />
              </svg>
              Call Emergency Services
            </button>
            
            <div id="emergency-message" class="mt-6 text-center text-sm text-gray-600 hidden">
              Emergency services have been notified of your location.
            </div>
          </div>
        </div>
        
        <div class="mt-6 text-center">
          <button id="back-to-landing" class="text-emergency hover:underline font-medium flex items-center justify-center mx-auto">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M9.707 14.707a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 1.414L7.414 9H15a1 1 0 110 2H7.414l2.293 2.293a1 1 0 010 1.414z" clip-rule="evenodd" />
            </svg>
            Back
          </button>
        </div>
      </div>
      
      <div id="empty-state" class="text-center py-8 hidden">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4 text-emergency" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
        </svg>
        <h2 class="text-xl font-semibold mb-2 text-gray-800">No Emergency Information Available</h2>
        <p class="text-gray-600 mb-6">
          Please complete your profile to provide critical medical information for emergencies.
        </p>
        <a href="index.html" class="inline-block bg-emergency text-white font-medium py-2 px-4 rounded-lg">
          Complete Your Profile
        </a>
      </div>
    </div>

    <script>
      // Emergency panel toggle
      const viewEmergencyInfoBtn = document.getElementById('view-emergency-info');
      const emergencyPanel = document.getElementById('emergency-panel');
      const emergencyLanding = document.getElementById('emergency-landing');
      const closeEmergencyPanel = document.getElementById('close-emergency-panel');
      const backToLanding = document.getElementById('back-to-landing');
      const emergencyCallBtn = document.getElementById('emergency-call-btn');
      const emergencyMessage = document.getElementById('emergency-message');
      const loadingElement = document.getElementById('loading');
      const emergencyContent = document.getElementById('emergency-content');
      const emptyStateElement = document.getElementById('empty-state');

      viewEmergencyInfoBtn.addEventListener('click', () => {
        emergencyPanel.classList.remove('hidden');
        emergencyLanding.classList.add('hidden');
        
        // Load emergency data
        loadEmergencyData();
      });

      closeEmergencyPanel.addEventListener('click', () => {
        emergencyPanel.classList.add('hidden');
        emergencyLanding.classList.remove('hidden');
      });
      
      backToLanding.addEventListener('click', () => {
        emergencyPanel.classList.add('hidden');
        emergencyLanding.classList.remove('hidden');
      });

      emergencyCallBtn.addEventListener('click', async () => {
        // Change button state to loading
        emergencyCallBtn.disabled = true;
        emergencyCallBtn.innerHTML = `
          <svg class="animate-spin h-5 w-5 mr-3" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          Sending...
        `;

        try {
          // Get user data and emergency contacts
          const userData = JSON.parse(localStorage.getItem('medivault_user_data') || '{}');
          const emergencyInfo = userData.emergencyInfo || {};
          
          // Default location
          let location = {
            latitude: 37.7749,
            longitude: -122.4194,
            accuracy: 100
          };
          
          // Try to get actual location if available
          if (navigator.geolocation) {
            try {
              const position = await new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(resolve, reject, {
                  enableHighAccuracy: true,
                  timeout: 5000,
                  maximumAge: 0
                });
              });
              
              location = {
                latitude: position.coords.latitude,
                longitude: position.coords.longitude,
                accuracy: position.coords.accuracy
              };
              
              console.log('Obtained location:', location);
            } catch (geoError) {
              console.error('Geolocation error:', geoError);
              // Continue with default location
            }
          }
          
          // Prepare the user info for the emergency message
          const userInfo = {
            name: `${userData.firstName || ''} ${userData.lastName || ''}`.trim() || 'Unknown User',
            bloodGroup: emergencyInfo.bloodGroup || 'Unknown',
            criticalConditions: emergencyInfo.criticalIllnesses || 'None reported',
            allergies: emergencyInfo.allergies || 'None reported'
          };
          
          // Make API call to backend
          const response = await fetch('http://localhost:5000/emergency-contact', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              location: location,
              contactInfo: {
                emergencyContacts: emergencyInfo.emergencyContacts || []
              },
              userInfo: userInfo
            })
          });
          
          const responseData = await response.json();
          console.log('Emergency response:', responseData);
          
          if (responseData.status === 'success') {
            // Show success message
            emergencyCallBtn.innerHTML = `
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
              </svg>
              Help is on the way
            `;
            emergencyMessage.classList.remove('hidden');
            emergencyMessage.textContent = 'Emergency services have been notified of your location. Emergency contacts have been alerted via SMS and call.';
          } else {
            throw new Error('Failed to send emergency notification');
          }
        } catch (error) {
          console.error('Error:', error);
          alert('Failed to send emergency notification. Please try calling emergency services directly.');
          
          // Reset button
          emergencyCallBtn.disabled = false;
          emergencyCallBtn.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
              <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z" />
            </svg>
            Call Emergency Services
          `;
        }
      });
      
      // Function to load emergency data from localStorage
      function loadEmergencyData() {
        // Show loading state
        loadingElement.classList.remove('hidden');
        emergencyContent.classList.add('hidden');
        emptyStateElement.classList.add('hidden');
        
        // Simulate loading delay
        setTimeout(() => {
          // Get user data from localStorage
          const userData = JSON.parse(localStorage.getItem('medivault_user_data') || '{}');
          
          // Hide loading state
          loadingElement.classList.add('hidden');
          
          // Check if emergency info exists
          if (!userData.emergencyInfo) {
            emptyStateElement.classList.remove('hidden');
            return;
          }
          
          // Show content
          emergencyContent.classList.remove('hidden');
          
          // Populate data
          const emergencyInfo = userData.emergencyInfo;
          
          // Blood group
          document.getElementById('emergency-blood-group').textContent = emergencyInfo.bloodGroup || '-';
          
          // Critical conditions
          const criticalConditionsList = document.getElementById('critical-conditions-list');
          criticalConditionsList.innerHTML = '';
          
          if (emergencyInfo.criticalIllnesses && emergencyInfo.criticalIllnesses !== 'None') {
            const conditions = emergencyInfo.criticalIllnesses.split(',').map(c => c.trim()).filter(c => c);
            
            if (conditions.length > 0) {
              conditions.forEach(condition => {
                const li = document.createElement('li');
                li.className = 'text-gray-800';
                li.textContent = condition;
                criticalConditionsList.appendChild(li);
              });
            } else {
              const li = document.createElement('li');
              li.className = 'text-gray-600';
              li.textContent = 'No critical conditions reported';
              criticalConditionsList.appendChild(li);
            }
          } else {
            const li = document.createElement('li');
            li.className = 'text-gray-600';
            li.textContent = 'No critical conditions reported';
            criticalConditionsList.appendChild(li);
          }
          
          // Allergies
          const allergiesList = document.getElementById('allergies-list');
          allergiesList.innerHTML = '';
          
          if (emergencyInfo.allergies && emergencyInfo.allergies !== 'None') {
            const allergies = emergencyInfo.allergies.split(',').map(a => a.trim()).filter(a => a);
            
            if (allergies.length > 0) {
              allergies.forEach(allergy => {
                const li = document.createElement('li');
                li.className = 'text-gray-800';
                li.textContent = allergy;
                allergiesList.appendChild(li);
              });
            } else {
              const li = document.createElement('li');
              li.className = 'text-gray-600';
              li.textContent = 'No allergies reported';
              allergiesList.appendChild(li);
            }
          } else {
            const li = document.createElement('li');
            li.className = 'text-gray-600';
            li.textContent = 'No allergies reported';
            allergiesList.appendChild(li);
          }
          
          // Emergency contacts
          const contactsElement = document.getElementById('emergency-contacts');
          contactsElement.innerHTML = '';
          
          if (emergencyInfo.emergencyContacts && emergencyInfo.emergencyContacts.length > 0) {
            emergencyInfo.emergencyContacts.forEach(contact => {
              if (contact.name && contact.phoneNumber) {
                const contactDiv = document.createElement('div');
                contactDiv.className = 'mb-4 border-b border-gray-200 pb-4 last:border-b-0 last:pb-0';
                contactDiv.innerHTML = `
                  <h3 class="font-medium text-gray-800">${contact.name}</h3>
                  <p class="text-gray-600">${contact.relationship || 'Contact'}</p>
                  <p class="text-gray-800 font-medium">${contact.phoneNumber}</p>
                `;
                contactsElement.appendChild(contactDiv);
              }
            });
          } else {
            contactsElement.innerHTML = '<p class="text-gray-600 mb-4">No emergency contacts provided</p>';
          }
          
          // Update last updated date
          if (emergencyInfo.lastUpdated) {
            const date = new Date(emergencyInfo.lastUpdated);
            document.getElementById('update-date').textContent = date.toLocaleString();
          }
          
        }, 800); // Simulate loading delay
      }
    </script>
  </body>
</html> 